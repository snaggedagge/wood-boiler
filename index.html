<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Boiler Stats</title>
  <style>
    :root{
      --bg: #0f172a;           /* slate-900 */
      --panel: #111827;        /* gray-900 */
      --panel-2:#0b1220;
      --text:#e5e7eb;          /* gray-200 */
      --muted:#9ca3af;         /* gray-400 */
      --accent:#22c55e;        /* green-500 */
      --accent-2:#60a5fa;      /* blue-400 */
      --warn:#f59e0b;          /* amber-500 */
      --danger:#ef4444;        /* red-500 */
      --border:#1f2937;        /* gray-800 */
      --card-radius: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg:#f3f4f6;
        --panel:#ffffff;
        --panel-2:#f9fafb;
        --text:#111827;
        --muted:#6b7280;
        --border:#e5e7eb;
        --shadow: 0 10px 25px rgba(0,0,0,.08);
      }
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 90% -10%, rgba(96,165,250,.15), transparent 60%), var(--bg);
      color:var(--text);
    }

    header{
      padding:28px 20px 10px;
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }
    .title{
      font-size:28px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      font-size:13px;
      margin-top:4px;
    }
    .pill{
      border:1px solid var(--border);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      background:var(--panel);
      box-shadow:var(--shadow);
    }

    main{max-width:1200px;margin:0 auto;padding:10px 20px 30px}

    .grid{
      display:grid;
      grid-template-columns: repeat(12,1fr);
      gap:18px;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)), var(--panel);
      border:1px solid var(--border);
      border-radius:var(--card-radius);
      padding:18px 18px 16px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }

    .card h3{
      margin:0 0 12px;
      font-size:14px;
      font-weight:600;
      color:var(--muted);
      letter-spacing:.3px;
      text-transform:uppercase;
    }

    .stat{
      font-size:30px;
      font-weight:700;
      letter-spacing:.3px;
    }
    .unit{font-size:14px;color:var(--muted);margin-left:6px}

    .row{display:flex;align-items:baseline;gap:6px}

    .span-3{grid-column:span 3}
    .span-4{grid-column:span 4}
    .span-6{grid-column:span 6}
    .span-12{grid-column:span 12}

    @media(max-width:900px){
      .span-3{grid-column:span 6}
      .span-4{grid-column:span 6}
      .span-6{grid-column:span 12}
    }
    @media(max-width:520px){
      .span-3,.span-4{grid-column:span 12}
    }

    .status{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;font-size:13px;font-weight:600
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .on{background:rgba(34,197,94,.12);color:var(--accent)}
    .on .dot{background:var(--accent)}
    .off{background:rgba(239,68,68,.12);color:var(--danger)}
    .off .dot{background:var(--danger)}

    .kv{display:grid;grid-template-columns:1fr auto;gap:10px 14px}
    .kv div{padding:6px 0;border-bottom:1px dashed var(--border)}
    .kv div:nth-child(2n){font-weight:600}

    .progress{height:10px;border-radius:999px;background:var(--panel-2);border:1px solid var(--border);overflow:hidden;margin-top:10px}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent-2),var(--accent));transition:width .6s ease}

    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:13px;line-height:1.55;
      max-height:320px;overflow:auto;padding-right:4px
    }
    .log-entry{padding:6px 8px;border-radius:8px}
    .log-entry:nth-child(odd){background:rgba(255,255,255,.03)}
    .muted{color:var(--muted)}
    .footer{margin-top:14px;font-size:12px;color:var(--muted)}
    .refresh{display:flex;align-items:center;gap:8px}
    .spinner{width:14px;height:14px;border-radius:50%;border:2px solid var(--border);border-top-color:var(--accent-2);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .progress{
      position:relative;
    }

    .target-marker{
      position:absolute;
      top:-4px;
      bottom:-4px;
      width:2px;
      background:var(--warn);
      left:0%;
      transform:translateX(-1px);
      pointer-events:none;
    }

    /* small triangle tip (optional but very nice visually) */
    .target-marker::after{
      content:'';
      position:absolute;
      top:-6px;
      left:50%;
      transform:translateX(-50%);
      border-left:5px solid transparent;
      border-right:5px solid transparent;
      border-bottom:6px solid var(--warn);
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">ðŸ”¥ Boiler Dashboard</div>
      <div class="subtitle">Live operating metrics</div>
    </div>
    <div class="pill refresh"><div class="spinner" id="spinner"></div><span id="last-updated">Updatingâ€¦</span></div>
  </header>

  <main>
    <section class="grid">
      <div class="card span-3">
        <h3>Water Temperature</h3>
        <div class="row"><div class="stat" id="water-temperature">--</div><div class="unit">Â°C</div></div>
      </div>

      <div class="card span-3">
        <h3>Exhaust Temperature</h3>
        <div class="row"><div class="stat" id="exhaust-temperature">--</div><div class="unit">Â°C</div></div>
        <div class="progress">
          <div class="bar" id="exhaust-bar"></div>
          <div class="target-marker" id="target-exhaust-marker"></div>
        </div>
      </div>

      <div class="card span-3">
        <h3>Burn Time</h3>
        <div class="row"><div class="stat" id="burn-time">--</div><div class="unit"></div></div>
      </div>
      <div class="card span-3">
        <h3>Total Lifetime Burn</h3>
        <div class="row"><div class="stat" id="lifetime-burn">--</div><div class="unit">h</div></div>
        <div class="footer">Since <span id="burn-since">--</span></div>
      </div>

      <div class="card span-3">
        <h3>Heating</h3>
        <div id="heating" class="status off"><span class="dot"></span><span>Off</span></div>
      </div>

      <div class="card span-6">
        <h3>Operating Parameters</h3>
        <div class="kv">
          <div>Primary Air Damper</div><div id="primary-air-damper">--</div>
          <div>Lower Exhaust Limit</div><div id="lower-exhaust-limit">--</div>
          <div>Upper Exhaust Limit</div><div id="upper-exhaust-limit">--</div>
          <div>Target Exhaust Temperature</div><div id="target-exhaust-temperature">--</div>
          <div>Free Heap</div><div id="free-heap">--</div>
          <div>Heap Fragmentation</div><div><span id="heap-fragmentation">--</span>%</div>
          <div>Reset Reason</div><div id="reset-reason" class="muted">--</div>
        </div>
        <div class="footer">Auto refresh every 5s</div>
      </div>

      <div class="card span-6">
        <h3>Controller Log</h3>
        <div id="log-entries" class="log">Loadingâ€¦</div>
        <div class="footer">Auto refresh every 3m</div>
      </div>
    </section>
  </main>

<script>
function setText(id, val){
  const el=document.getElementById(id);
  if(!el) return;
  el.textContent=(val===undefined||val===null||val==='')?'--':val;
}

function updateHeating(on){
  const el=document.getElementById('heating');
  if(!el) return;
  el.classList.toggle('on',!!on);
  el.classList.toggle('off',!on);
  el.querySelector('span:last-child').textContent=on?'Heating Active':'Idle';
}

function updateExhaustBar(temp, low, high, target){
  const bar = document.getElementById('exhaust-bar');
  const marker = document.getElementById('target-exhaust-marker');

  if(!bar || !marker) return;
  if(isNaN(temp) || isNaN(low) || isNaN(high) || high <= low) return;

  // --- Bar fill (current exhaust temp) ---
  let pct = ((temp - low) / (high - low)) * 100;
  pct = Math.max(0, Math.min(100, pct));
  bar.style.width = pct + '%';

  // --- Target marker position ---
  if(!isNaN(target)){
    let targetPct = ((target - low) / (high - low)) * 100;
    targetPct = Math.max(0, Math.min(100, targetPct));
    marker.style.left = targetPct + '%';
  }
}
function stamp(){
  const t=new Date();
  document.getElementById('last-updated').textContent='Updated '+t.toLocaleTimeString();
}

function formatMinutes(mins){
  mins = Number(mins);
  if(isNaN(mins)) return '--';

  const days = Math.floor(mins / 1440);
  const hours = Math.floor((mins % 1440) / 60);
  const minutes = mins % 60;

  if(days > 0)
    return `${days}d ${hours}h`;
  if(hours > 0)
    return `${hours}h ${minutes}m`;

  return `${minutes}m`;
}

function formatEpoch(epoch){
  epoch = Number(epoch);
  if(!epoch) return '--';

  const d = new Date(epoch * 1000);
  return d.toLocaleString();
}

async function updateInfo(){
  try{
    const r = await fetch('/api/info');
    const data = await r.json();

    document.getElementById('lifetime-burn').textContent =
      formatMinutes(data.completeBurnTimeMinutes);

    document.getElementById('burn-since').textContent =
      formatEpoch(data.since);

  }catch(e){
    console.error("info error", e);
  }
}

async function updateStats(){
  try{
    document.getElementById('spinner').style.opacity='1';
    const r=await fetch('/api/stats');
    const data=await r.json();
    
    setText('burn-time',formatMinutes(data.burnTime));
    setText('exhaust-temperature',data.exhaustTemperature);
    setText('water-temperature',data.waterTemperature);
    setText('lower-exhaust-limit',data.lowerExhaustLimit);
    setText('upper-exhaust-limit',data.upperExhaustLimit);
    setText('primary-air-damper',data.primaryAirDamper);
    setText('free-heap',data.freeHeap);
    setText('reset-reason',data.resetReason);
    setText('heap-fragmentation',data.heapFragmentation);
    setText('target-exhaust-temperature',data.targetExhaustTemperature);
    updateHeating(data.heating);
    updateExhaustBar(
      Number(data.exhaustTemperature),
      Number(data.lowerExhaustLimit),
      Number(data.upperExhaustLimit),
      Number(data.targetExhaustTemperature)
    );
    stamp();
  }catch(e){
    document.getElementById('last-updated').textContent='Connection error';
    console.error(e);
  }finally{
    document.getElementById('spinner').style.opacity='.25';
  }
}

async function updateLog(){
  const container=document.getElementById('log-entries');
  try{
    const r=await fetch('/api/logs');
    const data=await r.json();
    if(!Array.isArray(data)||data.length===0){
      container.innerHTML='<span class="muted">No log entries</span>';
      return;
    }
    container.innerHTML=data.map(entry=>{
      const corr=Number(entry.correction).toFixed(2);
      return `<div class=\"log-entry\">PID ${Math.round(entry.correction)} (${corr})  |  Temp ${entry.exhaustTemperature}Â°C  |  Burn ${entry.burnTimeMinutes} min</div>`;
    }).join('');
  }catch(e){
    container.innerHTML='<span class="muted">Error loading log</span>';
  }
}

setInterval(updateStats,5000);
setInterval(updateLog,180000);
updateStats();
updateLog();
updateInfo();
</script>
</body>
</html>
